<!-- Outer shell: fixed left, full height, animated width -->
<aside
  class="fixed top-0 left-0 z-40 h-full border-r border-blue-200 bg-blue-50 dark:border-navy-700 dark:bg-navy-800 transform-gpu transition-[width] duration-300 ease-in md:z-[60]"
  [class.w-16]="collapsed" [class.w-64]="!collapsed" role="navigation" aria-label="Primary">
  <div class="flex h-full w-full flex-col">
    <!-- Header: logo + toggle -->
    <div class="flex items-center justify-between px-3 pt-4">
      <a routerLink="/" class="flex items-center gap-2">
        <img class="h-11 w-11 transition-transform duration-500 ease-in-out hover:rotate-[360deg]"
          src="assets/images/app-logo.png" alt="App logo" />
        <!-- Hide brand text when collapsed -->
        <span class="text-sm font-semibold text-slate-700 dark:text-navy-100 transition-opacity duration-200"
          [class.opacity-0]="collapsed" [class.pointer-events-none]="collapsed">
          PM Tool
        </span>
      </a>

      <div class="flex items-center">
        <!-- some content -->
        <button type="button"
          class="inline-flex h-9 w-9 items-center justify-center rounded-full bg-blue-300 ml-auto hover:text-white hover:bg-blue-400 dark:hover:bg-navy-700"
          (click)="toggle()" [attr.aria-expanded]="!collapsed" [attr.aria-label]="ariaLabel" [title]="ariaLabel">
          <lucide-icon [name]="collapsed ? 'chevron-right' : 'chevron-left'" class="h-6 w-6"></lucide-icon>
        </button>
      </div>
      
    </div>

    <!-- Main nav -->
    <nav class="is-scrollbar-hidden flex grow flex-col gap-1 overflow-y-auto px-2 pt-6">
      <!-- Reusable item: icon always, label only when expanded -->
       @for(item of items; track item.label){
        <app-main-sidebar-item [icon]="item.icon" [label]="item.label" [tooltip]="item.tooltip" [redirectTo]="item.redirectTo"
          [collapsed]="collapsed" />
       }
    </nav>

    <!-- Bottom area (optional) -->
    <div class="px-2 py-3">
      @for(item of bottomItems; track item.label){
        @if (!item.children?.length) {
          <app-main-sidebar-item [icon]="item.icon" [label]="item.label" [tooltip]="item.tooltip" [redirectTo]="item.redirectTo"
            [collapsed]="collapsed" />
        } @else {
          <div class="mt-1 relative">
            <!-- Parent button (works in both states) -->
            <button type="button" class="group flex w-full items-center justify-between rounded-lg px-3 py-2 text-left text-sm transition
                           hover:bg-blue-100 dark:hover:bg-navy-700 text-slate-800" (click)="toggleAccordion(item.label)"
              [attr.aria-expanded]="isOpen(item.label)()" [attr.aria-controls]="'submenu-' + item.label"
              [title]="collapsed ? item.tooltip || item.label : null">
              <span class="inline-flex items-center gap-3 min-w-0">
                <lucide-icon [name]="item.icon" class="h-5 w-5 text-slate-800"></lucide-icon>
                <!-- Keep label visually hidden when collapsed -->
                <span class="truncate" [class.opacity-0]="collapsed" [class.pointer-events-none]="collapsed">
                  {{ item.label }}
                </span>
              </span>
              <lucide-icon name="chevron-down" class="transition-transform duration-200 h-4 w-4 text-slate-800"
                [class.rotate-180]="isOpen(item.label)()" [class.opacity-0]="collapsed" [class.pointer-events-none]="collapsed">
              </lucide-icon>
            </button>
          
            @if (!collapsed) {
            <div [id]="'submenu-' + item.label" class="overflow-hidden transition-[grid-template-rows] duration-200"
              [style.display]="'grid'" [style.gridTemplateRows]="isOpen(item.label)() ? '1fr' : '0fr'">
              <ul class="min-h-0 overflow-hidden pl-10 pr-2">
                @for (child of item.children; track child.label) {
                <li>
                  <a [routerLink]="child.redirectTo" routerLinkActive="bg-slate-100 dark:bg-navy-700"
                    class="group mt-0.5 flex items-center gap-2 rounded-lg px-3 py-2 text-sm transition hover:bg-blue-100 dark:hover:bg-navy-700"
                    [title]="child.tooltip || child.label">
                    <lucide-icon [name]="child.icon" class="h-4 w-4 text-slate-800"></lucide-icon>
                    <span class="truncate">{{ child.label }}</span>
                  </a>
                </li>
                }
              </ul>
            </div>
            } @else {
              @if (isOpen(item.label)()) {
                <div appClickOutside [clickOutsideEnabled]="true" (clickOutside)="toggleAccordion(item.label)" class="fixed z-[70] w-56 rounded-xl border border-slate-200 ml-12 bg-white p-1 shadow-lg
                           dark:border-navy-700 dark:bg-navy-800" [style.left.px]="flyoutPos()[item.label]?.left"
                  [style.top.px]="flyoutPos()[item.label]?.top" [style.maxHeight.px]="flyoutPos()[item.label]?.maxHeight"
                  style="overflow:auto; transform: translateY(-50%);">
                
                  <span class="pointer-events-none absolute top-1/2 -translate-y-1/2" [ngClass]="{
                            'left-[-5px]': flyoutPos()[item.label]?.side === 'right',
                            'right-[-5px]': flyoutPos()[item.label]?.side === 'left'
                          }">
                    <span class="block h-2 w-2 rotate-45 border border-slate-200 bg-white shadow-sm
                                   dark:border-navy-700 dark:bg-navy-800"></span>
                  </span>
                
                  <ul class="py-1">
                    @for (child of item.children; track child.label) {
                    <li>
                      <a [routerLink]="child.redirectTo"
                        class="flex items-center gap-2 rounded-lg px-3 py-2 text-sm hover:bg-blue-100 dark:hover:bg-navy-700"
                        [title]="child.tooltip || child.label" (click)="toggleAccordion(item.label)">
                        <lucide-icon [name]="child.icon" class="h-4 w-4 text-slate-800"></lucide-icon>
                        <span class="truncate">{{ child.label }}</span>
                      </a>
                    </li>
                    }
                  </ul>
                </div>
              } 
            }
          </div>
        }
      
      }
    </div>
  </div>
</aside>